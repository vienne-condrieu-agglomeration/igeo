{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"articles/2024/2024-04-15-postgresql-installtion/","title":"Installation de PostgreSQL sur un serveur Debian","text":"<p> Date de publication initiale : 15 avril 2024</p> <p>Note de l'auteur</p> <p>Nous commen\u00e7ons une s\u00e9rie d\u2019articles qui se veut \u00eatre un guide pour l'installation, la configuration, la maintenance et l'utilisation de PostgreSQL</p> <p>Les articles couvriront l\u2019installation et la configuration, mais aussi la mise en place de la sauvegarde, de la supervision, de la maintenance et de la r\u00e9plication dans des cas simples. Ce premier article concerne l\u2019installation.</p> <p>Info</p> <p>PostgreSQL est un syst\u00e8me de gestion de base de donn\u00e9es relationnelle et objet (SGBDRO). C'est un outil libre disponible selon les termes d'une licence de type BSD.</p> <p>L\u2019installation d\u2019un serveur PostgreSQL n\u2019offre pas vraiment de difficult\u00e9s. Certains points particuliers sont \u00e0 conna\u00eetre, notamment sur les syst\u00e8mes de fichiers, mais en fait, la difficult\u00e9 principale est de les conna\u00eetre, pas de les appliquer.</p> <p>L'installation de PostgreSQL se d\u00e9compose en six \u00e9tapes :</p> <ul> <li>Pr\u00e9paration du syst\u00e8me d\u2019exploitation,</li> <li>Installation du d\u00e9p\u00f4t de la communaut\u00e9,</li> <li>Installation des paquets,</li> <li>Configuration du service,</li> <li>Initialisation du r\u00e9pertoire de donn\u00e9es,</li> <li>Activation et d\u00e9marrage du service,</li> <li>Configuration de l\u2019utilisateur syst\u00e8me postgres.</li> </ul>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#preparation-du-systeme-dexploitation","title":"Pr\u00e9paration du syst\u00e8me d\u2019exploitation","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#systeme-hote","title":"Syst\u00e8me h\u00f4te","text":"<p>Cette installation est bas\u00e9e sur une machine virtuelle <code>VM</code> install\u00e9e avec Debian 12. Il s\u2019agit de la version <code>netinst</code>, nom de code <code>bookworm</code> pour PC 64 bits (amd64). Vous pouvez t\u00e9l\u00e9charger l'image iso debian-12.5.0-amd64-netinst.iso.</p> <p>Aucune option ne sortant de l'ordinaire n'a \u00e9t\u00e9 utilis\u00e9e pour l'installation de la distribution.</p> <p>La VM (sous VirtualBox) comprend :</p> <ul> <li>2 vCPU,</li> <li>2 Go de RAM,</li> <li>1 disque de 20 Go non allou\u00e9 enti\u00e8rement.</li> </ul> <p>Toutes les commandes de cet article seront \u00e0 ex\u00e9cuter avec l\u2019utilisateur <code>root</code> ou en utilisant la commande <code>sudo</code>.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#configuration-du-systeme-dexploitation","title":"Configuration du syst\u00e8me d\u2019exploitation","text":"<p>Il existe plusieurs param\u00e8tres du noyau Linux qui sont importants pour PostgreSQL. Un seul concerne sa stabilit\u00e9, les autres sont plut\u00f4t relatifs aux performances.</p> <p>Linux dispose d\u2019un syst\u00e8me qui lui permet d\u2019allouer aux applications plus de m\u00e9moire qu\u2019il n\u2019en a r\u00e9ellement.</p> <p>Overcommit Memory</p> <p>L\u2019id\u00e9e de base est simple : beaucoup d\u2019applications demandent de la m\u00e9moire, sans vraiment l\u2019utiliser. Les applications \u00e9crites en Java en sont un exemple typique : beaucoup de m\u00e9moire allou\u00e9e, mais au final peu r\u00e9ellement utilis\u00e9e. De ce fait, par d\u00e9faut, Linux accepte de donner plus de m\u00e9moire qu\u2019il n\u2019en a.</p> <p>Cela fonctionne g\u00e9n\u00e9ralement bien. Mais dans certains cas, comme par exemple avec PostgreSQL, cela peut causer de gros probl\u00e8mes. En effet, si les applications ont la mauvaise id\u00e9e d\u2019utiliser toute la m\u00e9moire qu\u2019elles ont allou\u00e9e, Linux risque de se retrouver \u00e0 court de m\u00e9moire. Dans ce cas, il d\u00e9cide de tuer les applications les plus consommatrices. </p> <p>Et malheureusement, PostgreSQL a tendance \u00e0 gagner facilement \u00e0 ce jeu-l\u00e0. Ce syst\u00e8me s\u2019appelle l\u2019Overcommit Memory et il convient de le d\u00e9sactiver sur un serveur d\u00e9di\u00e9 \u00e0 PostgreSQL.</p> <p>Pour cela, il faut configurer le param\u00e8tre <code>vm.overcommit_memory</code> \u00e0 la valeur 2. Le plus simple revient \u00e0 cr\u00e9er un fichier nomm\u00e9 <code>/etc/sysctl.d/S99-postgresql</code> avec ce contenu :</p> <pre><code>root@vm-postgres:~# vi /etc/sysctl.d/S99-postgresql\n</code></pre> <p>Ajouter la ligne : <pre><code>vm.overcommit_memory = 2\n</code></pre></p> <p>De cette fa\u00e7on, la configuration s\u2019appliquera \u00e0 chaque d\u00e9marrage du serveur.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#desactivation-des-transparent-huge-pages","title":"D\u00e9sactivation des Transparent Huge Pages","text":"<p>Dans <code>/proc/meminfo</code>, la ligne <code>AnonHugePages</code> indique des huge pages allou\u00e9es par le m\u00e9canisme de Transparent Huge Pages (THP) : le noyau Linux a d\u00e9tect\u00e9 une allocation contigu\u00eb de m\u00e9moire et l\u2019a convertie en huge pages, ind\u00e9pendamment du m\u00e9canisme d\u00e9crit plus haut. H\u00e9las, les <code>THP</code> ne s\u2019appliquent pas \u00e0 la m\u00e9moire partag\u00e9e de PostgreSQL.</p> <p>Les <code>THP</code> sont m\u00eame contre-productives sur une base de donn\u00e9es, \u00e0 cause de la latence engendr\u00e9e par la r\u00e9organisation par le syst\u00e8me d\u2019exploitation. Comme les <code>THP</code> sont activ\u00e9es par d\u00e9faut, il faut les d\u00e9sactiver au boot via <code>/etc/crontab</code> :</p> <pre><code>root@vm-postgres:~# @reboot  root  echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled\nroot@vm-postgres:~# @reboot  root  echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag\n</code></pre> <p>ou encore dans la configuration de <code>grub</code> : <pre><code>transparent_hugepage=never\n</code></pre></p> <p>Dans <code>/proc/meminfo</code>, la ligne <code>AnonHugePages</code> doit donc valoir 0.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#configuration-du-systeme-de-fichiers","title":"Configuration du syst\u00e8me de fichiers","text":"<p>Quel que soit le syst\u00e8me d\u2019exploitation, les syst\u00e8mes de fichiers ne manquent pas. Linux en est la preuve avec pas moins d\u2019une dizaine de syst\u00e8mes de fichiers. Le choix peut para\u00eetre compliqu\u00e9 mais il se r\u00e9v\u00e8le fort simple : il est pr\u00e9f\u00e9rable d\u2019utiliser le syst\u00e8me de fichiers pr\u00e9conis\u00e9 par votre distribution Linux. Ce syst\u00e8me est \u00e0 la base de tous les tests des d\u00e9veloppeurs de la distribution : il a donc plus de chances d\u2019avoir moins de bugs, tout en proposant plus de performances. Les instances de production PostgreSQL utilisent de fait soit <code>ext4</code>, soit <code>XFS</code>, qui sont donc les syst\u00e8mes de fichiers recommand\u00e9s.</p> <p>Performances et syst\u00e8me de fichier</p> <p>En 2016, un benchmark sur Linux de Tomas Vondra de diff\u00e9rents syst\u00e8mes de fichiers montrait que <code>ext4</code> et <code>XFS</code> ont des performantes \u00e9quivalentes.</p> <p>Autrefois r\u00e9serv\u00e9 \u00e0 Solaris, <code>ZFS</code> est un syst\u00e8me tr\u00e8s int\u00e9ressant gr\u00e2ce \u00e0 son panel fonctionnel et son m\u00e9canisme de <code>Copy On Write</code> permettant de faire une copie des fichiers sans arr\u00eater PostgreSQL (snapshot). OpenZFS, son portage sous Linux/FreeBSD, entre autres, est un syst\u00e8me de fichiers proposant un panel impressionnant de fonctionnalit\u00e9s (dont : checksum, compression, gestion de snapshot), les performances en \u00e9criture sont cependant bien moins bonnes qu\u2019avec <code>ext4</code> ou <code>XFS</code>. De plus, il est plus complexe \u00e0 mettre en place et \u00e0 administrer. <code>Btrfs</code> est relativement r\u00e9pandu et bien int\u00e9gr\u00e9 \u00e0 Linux, et offre une partie des fonctionnalit\u00e9s de <code>ZFS</code> ; mais il est \u00e9galement peu performant avec PostgreSQL.</p> <p><code>LVM</code> permet de rassembler plusieurs partitions dans un m\u00eame <code>Volume Group</code>, puis d\u2019y tailler des partitions (<code>Logical Volumes</code>) qui seront autant de points de montage. <code>LVM</code> permet de changer les tailles des <code>LV</code> \u00e0 volont\u00e9, d\u2019ajouter ou supprimer des disques physiques \u00e0 volont\u00e9 dans les <code>VG</code>, ce qui simplifie l\u2019administration au niveau PostgreSQL.</p> <p>LVM : le choix gagnant</p> <p>De nos jours, l\u2019impact en performance est n\u00e9gligeable pour la flexibilit\u00e9 apport\u00e9e.</p> <p>Si l\u2019on utilise les snapshots de <code>LVM</code>, il faudra v\u00e9rifier l\u2019impact sur les performances. <code>LVM</code> peut m\u00eame g\u00e9rer le RAID mais, dans l\u2019id\u00e9al, il est pr\u00e9f\u00e9rable qu\u2019une bonne carte RAID s\u2019en charge en dessous.</p> <p><code>NFS</code> peut sembler int\u00e9ressant, vu ses fonctionnalit\u00e9s : facilit\u00e9 de mise en \u0153uvre, administration centralis\u00e9e du stockage, mutualisation des espaces. Cependant, ce syst\u00e8me de fichiers est source de nombreux probl\u00e8mes avec PostgreSQL. Si la base tient en m\u00e9moire et que les latences possibles ne sont pas importantes, on peut \u00e9ventuellement utiliser <code>NFS</code>. Il faut la garantie que les op\u00e9rations sont synchrones. Si ce n\u2019est pas le cas, une panne sur la baie peut entra\u00eener une corruption des donn\u00e9es. Au minimum, l\u2019option <code>sync</code> doit \u00eatre pr\u00e9sente c\u00f4t\u00e9 serveur et les options <code>hard, proto=tcp, noac et nointr</code> doivent \u00eatre pr\u00e9sentes c\u00f4t\u00e9 client. Si vous souhaitez en apprendre plus sur le sujet des options pour <code>NFS</code>, un article d\u00e9taill\u00e9 est disponible dans la documentation de PostgreSQL \u00e0 partir de la version 12.</p> <p>NFS et PostgreSQL</p> <p>Par contre, <code>NFS</code> est totalement d\u00e9conseill\u00e9 dans les environnements critiques avec PostgreSQL. Greg Smith, contributeur tr\u00e8s connu, sp\u00e9cialis\u00e9 dans l\u2019optimisation de PostgreSQL, parle plus longuement des soucis de NFS avec PostgreSQL. En fait, il y a des dizaines d\u2019exemples de gens ayant eu des probl\u00e8mes avec <code>NFS</code>. Les probl\u00e8mes de performance sont quasi-syst\u00e9matiques, et ceux de fiabilit\u00e9 fr\u00e9quents, et compliqu\u00e9s \u00e0 diagnostiquer (comme illustr\u00e9 dans ce mail, o\u00f9 le probl\u00e8me venait du noyau Linux).</p> <p>Sous Windows, la question ne se pose pas : <code>NTFS</code> est le seul syst\u00e8me de fichiers assez stable. L\u2019installeur fourni par EnterpriseDB dispose d\u2019une protection qui emp\u00eache l\u2019installation d\u2019une instance PostgreSQL sur une partition <code>VFAT</code>.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#partitionnement","title":"Partitionnement","text":"<p>Nous allons donc configurer notre syst\u00e8me avec une structure <code>LVM</code> (Logical Volume Manager).</p> <p>Voici la liste des partitions et la structure LVM cr\u00e9\u00e9e :</p> <pre><code>root@vm-postgres:~# lsblk \nNAME                       MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsda                          8:0    0 223.6G  0 disk \n\u251c\u2500sda1                       8:1    0  1007K  0 part \n\u251c\u2500sda2                       8:2    0     1G  0 part \n\u251c\u2500sda3                       8:3    0    79G  0 part \n\u2502 \u251c\u2500pve-swap               253:2    0     2G  0 lvm  [SWAP]\n\u2502 \u251c\u2500pve-root               253:3    0  31.2G  0 lvm  /\n\u2502 \u251c\u2500pve-data_tmeta         253:4    0     1G  0 lvm  \n\u2502 \u2502 \u2514\u2500pve-data-tpool       253:6    0    34G  0 lvm  \n\u2502 \u2502   \u2514\u2500pve-data           253:7    0    34G  1 lvm  \n\u2502 \u2514\u2500pve-data_tdata         253:5    0    34G  0 lvm  \n\u2502   \u2514\u2500pve-data-tpool       253:6    0    34G  0 lvm  \n\u2502     \u2514\u2500pve-data           253:7    0    34G  1 lvm  \n\u2514\u2500sda4                       8:4    0 143.6G  0 part \n  \u251c\u2500fast1-vm--100--disk--0 253:0    0    22G  0 lvm  \n  \u2514\u2500fast1-vm--100--disk--1 253:1    0   100G  0 lvm\n</code></pre> <p>La partition <code>/var/lib/postgresql</code> contient les fichiers de PostgreSQL. Le sous-r\u00e9pertoire <code>/var/lib/postgresql/data</code> contient le r\u00e9pertoire principal des donn\u00e9es. La variable d'environnement <code>PGDATA</code> devra pointer vers ce r\u00e9pertoire. La partition <code>/var/lib/postgresql/wal</code> contient uniquement les journaux de transactions de PostgreSQL. Il est g\u00e9n\u00e9ralement conseill\u00e9 de s\u00e9parer fichiers de donn\u00e9es et journaux de transactions dans des partitions diff\u00e9rentes, nous le faisons donc ici. Il est aussi g\u00e9n\u00e9ralement conseill\u00e9 de d\u00e9placer les journaux applicatifs de PostgreSQL dans une partition s\u00e9par\u00e9e. Cela se fera dans le chapitre sur la configuration, <code>/var/log/postgresql</code> \u00e9tant le r\u00e9pertoire choisi, ce dernier d\u00e9pendant de la partition <code>/var</code>.</p> <p>Au cas o\u00f9 vous voudriez installer une version ant\u00e9rieure \u00e0 la 15, les statistiques d\u2019activit\u00e9s sont stock\u00e9es sur disque et il est g\u00e9n\u00e9ralement pr\u00e9f\u00e9rable de les placer sur un ramdisk pour gagner en performances. Ce n\u2019est plus le cas en version 15 vu que les m\u00e9triques sont conserv\u00e9es en m\u00e9moire pendant toute la dur\u00e9e d\u2019ex\u00e9cution du serveur.</p> <p>M\u00eame si tous les exemples se basent sur Debian, les commandes doivent \u00eatre utilisables sur toute distribution, quelle que soit sa version.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#option-noatime","title":"Option <code>noatime</code>","text":"<p>Sur les syst\u00e8mes le supportant, la configuration <code>noatime</code> \u00e9vite l\u2019\u00e9criture de l\u2019horodatage du dernier acc\u00e8s au fichier.</p> <p><code>nodiratime</code> fait de m\u00eame au niveau du r\u00e9pertoire. Depuis plusieurs ann\u00e9es maintenant, <code>nodiratime</code> est inclus dans <code>noatime</code>.</p> <p><code>dir_index</code></p> <p>Pour aller plus loin, l'option <code>dir_index</code> permet de modifier la m\u00e9thode de recherche des fichiers dans un r\u00e9pertoire en utilisant un index sp\u00e9cifique pour acc\u00e9l\u00e9rer cette op\u00e9ration. L\u2019outil <code>tune2fs</code> permet de s\u2019assurer que cette fonctionnalit\u00e9 est activ\u00e9e ou non.</p> <p>Par exemple, pour une partition /dev/sda1 : <pre><code>root@vm-postgres:~# sudo tune2fs -l /dev/sda1 | grep features\nFilesystem features:      has_journal resize_inode **dir_index** filetype\n                          needs_recovery sparse_super large_file\n</code></pre></p> <p><code>dir_index</code> est activ\u00e9 par d\u00e9faut sur <code>ext3</code> et <code>ext4</code>. Il ne pourrait \u00eatre absent que si le syst\u00e8me de fichiers \u00e9tait originellement un syst\u00e8me ext2, qui aurait \u00e9t\u00e9 mal migr\u00e9.</p> <p>Pour l\u2019activer, il faut utiliser l\u2019outil <code>tune2fs</code>. Par exemple : <pre><code>root@vm-postgres:~# sudo tune2fs -O dir_index /dev/sda1\n</code></pre></p> <p>Enfin, il reste \u00e0 cr\u00e9er ces index \u00e0 l\u2019aide de la commande <code>e2fsck</code> : <pre><code>root@vm-postgres:~# sudo e2fsck -D /dev/sda1\n</code></pre></p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#autres-options-relatives-aux-performances-de-postgresql","title":"Autres options relatives aux performances de PostgreSQL","text":"<p>Pour finir et pour notre culture g\u00e9n\u00e9rale, voici d'autres param\u00e8tres relatifs aux performances de PostgreSQL mais qui ont un effet tr\u00e8s peu significatif sur le gain de performances du serveur. Je ne les d\u00e9taillerai pas dans cet article mais en voici la liste pour les curieux et curieuses :</p> <pre><code>vm.dirty_background_bytes\nvm.dirty_background_ratio\nvm.dirty_bytes\nvm.dirty_ratio\nvm.nr_hugepages\nvm.nr_overcommit_hugepages\nvm.overcommit_ratio\nvm.swappinesss\nvm.zone_reclaim_mode\n</code></pre> <p>Si vous souhaitez aller plus loin, je vous conseille de lire l'excellente documentation sur PostgreSQL et ses performances fournit par Dalibo sur laquelle j'ai pioch\u00e9 quelques extraits pour d\u00e9tailler cette doc.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#installation-du-depot-de-la-communaute","title":"Installation du d\u00e9p\u00f4t de la communaut\u00e9","text":"<p>PostgreSQL est disponible dans toutes les versions Debian par d\u00e9faut. Cependant, Debian \"snapshot\" une version sp\u00e9cifique de PostgreSQL qui est ensuite prise en charge tout au long la dur\u00e9e de vie de cette version Debian. </p> <p>Si la version incluse dans notre version de Debian n'est pas celle que l'on souhaite, on peut utiliser le d\u00e9p\u00f4t de paquets de la communaut\u00e9 PostgreSQL. Les mises \u00e0 jour, majeures et mineures, sont souvent disponibles bien plus rapidement. C'est d'autant plus important pour les mises \u00e0 jour mineures comprenant des failles de s\u00e9curit\u00e9. Il est essentiel de les mettre \u00e0 jour d\u00e8s l'annonce de la sortie de versions mineures. </p> <p>Pour configurer manuellement le r\u00e9f\u00e9rentiel <code>Apt</code> sur notre Debian, suivez les \u00e9tapes suivantes : https://www.postgresql.org/download/linux/debian/ <pre><code># Importer la cl\u00e9 de signature du r\u00e9f\u00e9rentiel\nuser@vm-postgres:~# sudo apt install curl ca-certificates\nuser@vm-postgres:~# sudo install -d /usr/share/postgresql-common/pgdg\nuser@vm-postgres:~# sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc\n\n# Cr\u00e9ez le fichier de configuration du r\u00e9f\u00e9rentiel\nuser@vm-postgres:~# sudo sh -c 'echo \"deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" &gt; /etc/apt/sources.list.d/pgdg.list'\n\n# Mettre \u00e0 jour les listes de paquets\nuser@vm-postgres:~# sudo apt update\n</code></pre></p> <p>Le d\u00e9p\u00f4t contient de nombreux ensembles diff\u00e9rents, y compris des tiers, addons. Les paquets les plus courants et les plus importants sont :</p> Paquet Description postgresql-16 Noyau du serveur de base de donn\u00e9es PostgreSQL postgresql-client-16 Biblioth\u00e8ques clientes et binaires clients postgresql-doc-16 Documentation libpq-dev Biblioth\u00e8ques et en-t\u00eates pour le d\u00e9veloppement du frontend de la langue C postgresql-server-dev-16 Biblioth\u00e8ques et en-t\u00eates pour le d\u00e9veloppement de l'arri\u00e8re-plan de langage C postgresql-16-postgis-3<sup>1</sup> Prise en charge des objets g\u00e9ographiques pour PostgreSQL postgresql-16-pgrouting<sup>2</sup> Prise en charge de la fonction itin\u00e9raire pour PostgreSQL/PostGIS","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#installation-des-paquets","title":"Installation des paquets","text":"<p>Nous allons donc installer plusieurs paquets pour PostgreSQL :</p> <pre><code># Installez la derni\u00e8re version de PostgreSQL\n# Si vous voulez une version sp\u00e9cifique, utilisez 'postgresql-16'\n# ou similaire au lieu de 'postgresql'\nroot@vm-postgres:~# apt install \\\n    postgresql-16 \\\n    postgresql-client-16 \\\n    postgresql-doc-16 \\\n    libpq-dev \\\n    postgresql-server-dev-16 \\\n    postgresql-16-postgis-3 \\\n    postgresql-16-pgrouting\n</code></pre>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#configuration-du-service","title":"Configuration du service","text":"<p>Comme nous allons placer le r\u00e9pertoire de donn\u00e9es dans un r\u00e9pertoire autre que l'habituel <code>/var/lib/postgresql/16/data</code>, il nous faut modifier la configuration du service.</p> <p>\u00c0 cette fin, il faut cr\u00e9er un fichier <code>override.conf</code> qui va permettre, comme son nom l\u2019indique, de surcharger la configuration par d\u00e9faut. Cela se fait avec les deux commandes suivantes : <pre><code>root@vm-postgres:~# mkdir -p /etc/systemd/system/postgresql-16.service.d\nroot@vm-postgres:~# cat &gt; /etc/systemd/system/postgresql-16.service.d/override.conf &lt;&lt;_EOF_\n[Service]\nEnvironment=PGDATA=/srv/data\n_EOF_\n</code></pre></p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#initialisation-du-repertoire-de-donnees","title":"Initialisation du r\u00e9pertoire de donn\u00e9es","text":"<p>Maintenant, il nous faut pr\u00e9parer le r\u00e9pertoire des fichiers de donn\u00e9es et celui des journaux de transactions :</p> <pre><code>root@vm-postgres:~# install -d -o postgres -g postgres -m 700 /srv/data\nroot@vm-postgres:~# rm -rf /srv/wal/lost+found/\nroot@vm-postgres:~# chown -R postgres:postgres /srv/wal\n</code></pre> <p>Enfin, nous pouvons initialiser le r\u00e9pertoire des donn\u00e9es : <pre><code>root@vm-postgres:~# PGSETUP_INITDB_OPTIONS=\"--data-checksums --waldir /srv/wal\" /usr/pgsql-15/bin/postgresql-15-setup initdb\n</code></pre></p> <p>L'option <code>--data-checksums</code> permet d'activer les sommes de contr\u00f4le sur les fichiers de donn\u00e9es. Ces sommes de contr\u00f4le permettent d\u2019\u00eatre pr\u00e9venu en cas de corruption dans les fichiers de donn\u00e9es. L'option <code>--waldir</code> permet d'indiquer un autre r\u00e9pertoire de stockage pour les journaux de transactions.</p> <p>La commande <code>initdb</code> va cr\u00e9er les r\u00e9pertoires et fichiers n\u00e9cessaires pour pouvoir d\u00e9marrer PostgreSQL. Ces fichiers \u00e9tant cr\u00e9\u00e9s, il ne nous reste plus qu'\u00e0 activer le service et le d\u00e9marrer.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#activation-et-demarrage-du-service","title":"Activation et d\u00e9marrage du service","text":"<p>L\u2019activation et le d\u00e9marrage sont deux commandes s\u00e9par\u00e9es pour systemd. Le service PostgreSQL pour ce dernier \u00e9tant configur\u00e9, il ne reste plus qu\u2019\u00e0 les ex\u00e9cuter :</p> <pre><code>root@vm-postgres:~# systemctl enable postgresql-16\nroot@vm-postgres:~# systemctl start postgresql-16\n</code></pre>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#configuration-de-lutilisateur-systeme-postgres","title":"Configuration de l\u2019utilisateur syst\u00e8me postgres","text":"<p>Ce r\u00f4le n\u2019a pas de mot de passe par d\u00e9faut. Ajoutez-en un si vous le souhaitez : <pre><code>root@vm-postgres:~# passwd postgres\n</code></pre></p> <p>Ajoutez surtout dans le fichier d\u2019initialisation de session (<code>.profile, .bash_profile, ou autre</code>) la configuration de la variable d\u2019environnement <code>PGDATA</code>.</p> <p>Celle-ci doit pointer vers le r\u00e9pertoire d\u2019installation de PostgreSQL : <pre><code>root@vm-postgres:~# export PGDATA=/srv/data\n</code></pre></p> <p>\u00c0 noter que l'installation de <code>posgtreSQL</code> via les paquets le fait bien, cependant le r\u00e9pertoire indiqu\u00e9 pointe vers le r\u00e9pertoire par d\u00e9faut (<code>/var/lib/poistgresql/16/data</code>), et non pas vers le r\u00e9pertoire personnalis\u00e9 que nous avons choisi.</p> <p>Il est aussi int\u00e9ressant de modifier la variable d\u2019environnement <code>PATH</code> pour pointer vers les binaires de PostgreSQL, soit : <pre><code>root@vm-postgres:~# export PATH=/usr/pgsql-16/bin:$PATH\n</code></pre></p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-15-postgresql-installtion/#conclusion","title":"Conclusion","text":"<p>Et voil\u00e0, cela conclut l'installation de PostgreSQL sur un serveur Debian. Maintenant, l'\u00e9tape suivante est de la configurer un minimum. Ce sera l'objet du prochain article de cette s\u00e9rie.</p> <ol> <li> <p>Seulement si vous avez besoin de la prise en charge des objets g\u00e9ographiques pour PostgreSQL\u00a0\u21a9</p> </li> <li> <p>Seulement si vous avez besoin de la prise en charge de la fonction itin\u00e9raire pour PostgreSQL/PostGIS\u00a0\u21a9</p> </li> </ol>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Installation"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/","title":"Configuration de base d'une instance PostgreSQL sur un serveur Debian","text":"<p> Date de publication initiale : 17 avril 2024</p> <p>Note de l'auteur</p> <p>Nous commen\u00e7ons une s\u00e9rie d\u2019articles qui se veut \u00eatre un guide pour l'installation, la maintenance et l'utilisation de PostgreSQL.</p> <p>Les articles couvriront l\u2019installation et la configuration, mais aussi la mise en place de la sauvegarde, de la supervision, de la maintenance et de la r\u00e9plication dans des cas simples. Ce premier article concerne l\u2019installation.</p> <p>Info</p> <p>PostgreSQL est un syst\u00e8me de gestion de base de donn\u00e9es relationnelle et objet (SGBDRO). C'est un outil libre disponible selon les termes d'une licence de type BSD.</p>","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#configuration-du-moteur-de-bases-de-donnees","title":"Configuration du moteur de bases de donn\u00e9es","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#connexions","title":"Connexions","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#memoire","title":"M\u00e9moire","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#parallelisation","title":"Parall\u00e9lisation","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#checkpoints","title":"Checkpoints","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#optimisation-des-requetes","title":"Optimisation des requ\u00eates","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#traces-de-postgresql","title":"Traces de PostgreSQL","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#statistiques-dactivite","title":"Statistiques d\u2019activit\u00e9","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#et-le-reste","title":"Et le reste","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#details-sur-la-configuration","title":"D\u00e9tails sur la configuration","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#configuration-des-acces","title":"Configuration des acc\u00e8s","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#extensions-par-defaut","title":"Extensions par d\u00e9faut","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-17-postgresql-configuration/#conclusion","title":"Conclusion","text":"","tags":["Potgres","Postgis","SQL","Debian","Linux","S\u00e9rie","Configuration"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/","title":"Reversement partiel du produit de la taxe fonci\u00e8re sur les Zones d'Activit\u00e9s \u00c9conomiques (ZAE)","text":"<p>EXTRAIT DU REGISTRE DES DELIBERATIONS DU CONSEIL COMMUNAUTAIRE</p> <p>D\u00e9lib\u00e9ration N\u00b015-111 de la s\u00e9ance du 25 juin 2015</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#preambule","title":"Pr\u00e9ambule","text":"<p>Les difficult\u00e9s financi\u00e8res auxquelles sont confront\u00e9es les collectivit\u00e9s locales mettent en \u00e9vidence la modification profonde du mod\u00e8le \u00e9conomique et fiscal des EPCI et des relations avec les communes. A une p\u00e9riode o\u00f9 les recettes fiscales, et donc le financement des actions, d\u00e9pendaient du dynamisme du tissu \u00e9conomique, a succ\u00e9d\u00e9 une nouvelle \u00e8re o\u00f9 la base locative fonci\u00e8re est devenue le principal socle de fiscalit\u00e9. </p> <p>Le contexte budg\u00e9taire impos\u00e9 aux collectivit\u00e9s locales oblige \u00e0 s'interroger sur le financement des politiques publiques. Dans ce cadre, les \u00e9lus communautaires ont conscience que c'est le d\u00e9veloppement et le renouvellement des bases fiscales qui conditionnera le rythme des d\u00e9penses et le choix dans les investissements.</p> <p>Cette nouvelle situation \u00e9claire le retour fiscal paradoxal et qui n'est pas en rapport avec les investissements respectifs consentis par les communes et l'intercommunalit\u00e9. </p> <p>En effet, alors que c'est l'intercommunalit\u00e9 qui supporte la totalit\u00e9 des d\u00e9penses n\u00e9cessaires \u00e0 la cr\u00e9ation de sites \u00e9conomiques, le retour fiscal, qui permet de financer les actions intercommunales dans tous les domaines, se traduit principalement par la CFE tandis que la totalit\u00e9 du produit des taxes fonci\u00e8res g\u00e9n\u00e9r\u00e9 par ces investissements revient aux communes.</p> <p>C'est pourquoi il a \u00e9t\u00e9 d\u00e9cid\u00e9 d'instaurer un dispositif de partage de la fiscalit\u00e9 sur les sites \u00e9conomiques cr\u00e9\u00e9s par l'Agglom\u00e9ration, conform\u00e9ment \u00e0 l'article 29-11 de la Loi n\u00b080-10 du 10 janvier 1980 portant am\u00e9nagement de la fiscalit\u00e9 directe locale qui pr\u00e9voit : </p> <p>Article 29-11 de la Loi n\u00b080-10 du 10 janvier 1980</p> <p>Lorsqu'un groupement de communes (. . .) cr\u00e9e ou g\u00e9re une zone d'activit\u00e9s \u00e9conomiques, tout ou partie de la part communale de la taxe fonci\u00e8re sur les propri\u00e9t\u00e9s b\u00e2ties acquitt\u00e9e par les entreprises implant\u00e9es sur cette zone d'activit\u00e9s peut \u00eatre affect\u00e9 au groupement (...) par d\u00e9lib\u00e9rations concordantes de l'organe de gestion du groupement (...) et de la ou des communes sur le territoire desquelles est install\u00e9e la zone d'activit\u00e9s \u00e9conomiques.</p> <p>Pour le territoire de l'Agglom\u00e9ration, le dispositif est institu\u00e9 selon les principes suivants :</p> <ul> <li>Partage \u00e0 parts \u00e9gales du produit annuel de la taxe fonci\u00e8re sur les propri\u00e9t\u00e9s b\u00e2ties pour les op\u00e9rations r\u00e9sultant d'un investissement de l'Agglom\u00e9ration,</li> <li>Partage \u00e9ventuel du produit de la taxe d'am\u00e9nagement au cas par cas, afin d'\u00e9quilibrer le budget pr\u00e9visionnel d'investissements d'une op\u00e9ration.</li> </ul> <p>Ce dispositif s'appliquera \u00e0 partir de 2015 (ann\u00e9e fiscale de r\u00e9f\u00e9rence), sans effet r\u00e9troactif afin de ne pas p\u00e9naliser les budgets communaux. Il est \u00e9galement rappel\u00e9 que ce transfert de produit fiscal entraine une correction sym\u00e9trique des potentiels fiscaux des communes concern\u00e9es afin de ne pas p\u00e9naliser ces derni\u00e8res pour le montant de la DGF.</p> <p>Les sites identifi\u00e9s (zones enti\u00e8res ou parcelles concern\u00e9es) feront l'objet de d\u00e9lib\u00e9rations ult\u00e9rieures \u00e0 celle de l'Agglom\u00e9ration par les communes concern\u00e9es. Une convention relative aux modalit\u00e9s de reversement et sera sign\u00e9e avec la commune pour chaque site identifi\u00e9.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#conventionnement","title":"Conventionnement","text":"","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#modalites-de-versement","title":"Modalit\u00e9s de versement","text":"<p>Chaque ann\u00e9e, le versement au profit de Vienne Condrieu Agglom\u00e9ration sera \u00e9tabli sur la base des taxes fonci\u00e8res sur les propri\u00e9t\u00e9s b\u00e2ties issues des zones concern\u00e9es par le champ d'application de la convention et encaiss\u00e9es par la commune au cours de l'exercice pr\u00e9c\u00e9dent.</p> <p>Pour ce faire, un \u00e9tat des versements \u00e0 op\u00e9rer \u00e9tabli sur la base des donn\u00e9es N-1 sera adress\u00e9 \u00e0 la commune par les services de l'Agglom\u00e9ration avant le 15 mars de l'ann\u00e9e N. Il sera \u00e9tabli \u00e0 partir des informations transmises par les services fiscaux, notamment via les donn\u00e9es MAJIC.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#modalites-de-calcul","title":"Modalit\u00e9s de calcul","text":"<p>Le montant du reversement au titre de l'ann\u00e9e N est calcul\u00e9 en appliquant \u00e0 50% des bases nettes d'imposition de l'ann\u00e9e N-1 des redevables concern\u00e9s multipli\u00e9 par le taux de la taxe fonci\u00e8re sur les propri\u00e9t\u00e9s b\u00e2ties vot\u00e9 par la commune pour cette m\u00eame ann\u00e9e (N-1).</p> <p>Calcul du montant de reversement</p> <p>Montant du reversement (ann\u00e9e N) = (Bases nettes d'imposition (ann\u00e9e N-1) des sites concern\u00e9s x %) x taux communal TFPB de l'ann\u00e9e nN-1.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#paiement","title":"Paiement","text":"<p>Les versements seront \u00e9tablis sur une base annuelle, avec un paiement au 30 juin de chaque ann\u00e9e.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#inscriptions-budgetaires","title":"Inscriptions budg\u00e9taires","text":"<p>Les reversements de la Taxe Fonci\u00e8re des propri\u00e9t\u00e9s B\u00e2ties (TFPB) seront imput\u00e9s en section de fonctionnement en chapitre 014 pour la commune et en chapitre 73 pour Vienne Condrieu Agglom\u00e9ration.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#mise-en-oeuvre-sig","title":"Mise en oeuvre SIG","text":"<p>Note</p> <p>La mise en oeuvre de cette application a \u00e9t\u00e9 r\u00e9alis\u00e9 sous QGIS et en analysant les fichiers fonciers MAJIC qui nous sont fournis chaque ann\u00e9e.</p> <p>Par cons\u00e9quent, chaque ann\u00e9e, une r\u00e9vision des titres est effectu\u00e9e en fonction des nouveaux mill\u00e9sime des donn\u00e9es MAJIC et des sites conventionn\u00e9s avec les communes.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#atlas-qgis","title":"Atlas QGIS","text":"<p>Les titres sont \u00e9mis gr\u00e2ce \u00e0 un atlas r\u00e9alis\u00e9 sous QGIS et un mod\u00e8le d'impression au format A4.</p> <p>L'atlas vient boucler sur une couche de parcelles identifi\u00e9e et sur laquelle diff\u00e9rentes tables g\u00e9n\u00e9r\u00e9es sous Postgresql lui sont jointes.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#les-requetes-sql","title":"Les requ\u00eates SQL","text":"<p>Afin de p\u00e9renniser au mieux la g\u00e9n\u00e9ration de ces titres qui seront \u00e9dit\u00e9s chaque ann\u00e9e, l'ensemble du projet QGIS se repose sur l'import des donn\u00e9es MAJIC via l'extension Cadastre de QGIS d\u00e9velopp\u00e9 par la soci\u00e9t\u00e9 3liz.</p> <p>Ce projet repose sur 2 requ\u00eates SQL en particulier.</p> <p>Voici la premi\u00e8re : <pre><code>DROP TABLE IF EXISTS taxe.majic2023_revenu_cadastral;\nCREATE TABLE taxe.majic2023_revenu_cadastral AS\nSELECT  RIGHT(cadastre_2023.local00.parcelle,12) AS keypar,\n    cadastre_2023.local00.ccodep || cadastre_2023.local00.ccocom AS code_insee,\n    cadastre_2023.pev.invar,\n    cadastre_2023.pev.ccoaff AS code_affectation,\n    CASE\n      WHEN cadastre_2023.pev.ccoaff = 'A' THEN 'Locaux commerciaux et biens divers passibles de la TH'\n      WHEN cadastre_2023.pev.ccoaff = 'B' THEN 'B\u00e2timent industriel (li\u00e9 \u00e0 CCOEVA = A ou E)'\n      WHEN cadastre_2023.pev.ccoaff = 'C' THEN 'Commerce'\n      WHEN cadastre_2023.pev.ccoaff = 'E' THEN 'Locaux commerciaux et biens divers non passibles de la TH ni de la TP'\n      WHEN cadastre_2023.pev.ccoaff = 'H' THEN 'Habitation'\n      WHEN cadastre_2023.pev.ccoaff = 'K' THEN 'Locaux administratifs non passibles de la TH'\n      WHEN cadastre_2023.pev.ccoaff = 'L' THEN 'H\u00f4tel'\n      WHEN cadastre_2023.pev.ccoaff = 'P' THEN 'Professionnel'\n      WHEN cadastre_2023.pev.ccoaff = 'S' THEN 'Biens divers passibles de la TH'\n      WHEN cadastre_2023.pev.ccoaff = 'T' THEN 'Terrain industriel (li\u00e9 \u00e0 CCOEVA = A ou E)'\n      ELSE 'Erreur dans la base'::text\n    END libelle_affectation,\n    cadastre_2023.local10.cconlc AS code_nature_local,\n    CASE\n      WHEN cadastre_2023.local10.cconlc = 'AP' THEN 'Appartement'\n      WHEN cadastre_2023.local10.cconlc = 'AT' THEN 'Antenne t\u00e9l\u00e9phone'\n      WHEN cadastre_2023.local10.cconlc = 'AU' THEN 'Autoroute'\n      WHEN cadastre_2023.local10.cconlc = 'CA' THEN 'Commerce sans boutique'\n      WHEN cadastre_2023.local10.cconlc = 'CB' THEN 'Local divers'\n      WHEN cadastre_2023.local10.cconlc = 'CD' THEN 'D\u00e9pendance commerciale'\n      WHEN cadastre_2023.local10.cconlc = 'CH' THEN 'Chantier'\n      WHEN cadastre_2023.local10.cconlc = 'CM' THEN 'Commerce avec boutique'\n      WHEN cadastre_2023.local10.cconlc = 'DC' THEN 'D\u00e9pendance lieux communs'\n      WHEN cadastre_2023.local10.cconlc = 'DE' THEN 'D\u00e9pendance b\u00e2tie isol\u00e9e'\n      WHEN cadastre_2023.local10.cconlc = 'LC' THEN 'Local commun'\n      WHEN cadastre_2023.local10.cconlc = 'MA' THEN 'Maison'\n      WHEN cadastre_2023.local10.cconlc = 'ME' THEN 'Maison exceptionnelle'\n      WHEN cadastre_2023.local10.cconlc = 'MP' THEN 'Maison partag\u00e9e par une limite territoriale'\n      WHEN cadastre_2023.local10.cconlc = 'SM' THEN 'Sol de maison'\n      WHEN cadastre_2023.local10.cconlc = 'U' THEN 'Etablissement industriel (\u00e9valu\u00e9 par m\u00e9thode comptable)'\n      WHEN cadastre_2023.local10.cconlc = 'U1' THEN 'Gare'\n      WHEN cadastre_2023.local10.cconlc = 'U2' THEN 'Gare : triage'\n      WHEN cadastre_2023.local10.cconlc = 'U3' THEN 'Gare : atelier mat\u00e9riel'\n      WHEN cadastre_2023.local10.cconlc = 'U4' THEN 'Gare : atelier magasin'\n      WHEN cadastre_2023.local10.cconlc = 'U5' THEN 'Gare : d\u00e9p\u00f4t - titulaire'\n      WHEN cadastre_2023.local10.cconlc = 'U6' THEN 'Gare : d\u00e9p\u00f4t - r\u00e9el'\n      WHEN cadastre_2023.local10.cconlc = 'U7' THEN 'Gare : mat\u00e9riel transport'\n      WHEN cadastre_2023.local10.cconlc = 'U8' THEN 'Gare : entretien mat\u00e9riel roulant'\n      WHEN cadastre_2023.local10.cconlc = 'U9' THEN 'Gare : Station usine'\n      WHEN cadastre_2023.local10.cconlc = 'UE' THEN 'Transformateur \u00e9lectrique'\n      WHEN cadastre_2023.local10.cconlc = 'UG' THEN 'Appareil \u00e0 gaz'\n      WHEN cadastre_2023.local10.cconlc = 'UN' THEN 'Usine nucl\u00e9aire'\n      WHEN cadastre_2023.local10.cconlc = 'US' THEN 'Etablissement industriel (\u00e9valu\u00e9 par m\u00e9thode particuli\u00e8re)'\n      ELSE 'Erreur dans la base'::text\n    END libelle_nature_local,\n    cadastre_2023.pev.dsupot AS surface_pondere_m2_pev,\n    cadastre_2023.pevprofessionnelle.dsupot AS surface_pondere_m2_pev_pro,\n    ------------------------------ CALCUL REVERSEMENT ----------------------------------------- \n    ROUND(role.tf_header_article_a1_commune_taux.taux_bati_commune,2) AS taux_bati_commune,\n    ROUND(role.tf_header_article_a1_commune_taux.taux_nonbati_commune,2) AS taux_nonbati_commune,\n    cadastre_2023.pev.dvlpera AS valeur_locative_pev, -- Valeur locative de la PEV, en valeur de l'ann\u00e9e\n    ROUND(((cadastre_2023.pev.dvlpera)::double precision/2)::numeric) AS revenu_cadastral,\n    --cadastre_2023.pevtaxation.co_vlbai,               -- Commune - Part de VL impos\u00e9e (valeur70) -\n    --cadastre_2023.pevtaxation.co_vlbaia,              -- Commune - Part de VL impos\u00e9e (valeur de l\u2019ann\u00e9e) -\n    cadastre_2023.pevtaxation.co_bipevla AS base_imposition_pev_communale,  -- Commune - Base d\u2019imposition de la pev(valeur de l\u2019ann\u00e9e)\n    --cadastre_2023.pevtaxation.gp_vlbai,               -- Groupement de commune - Part de VL impos\u00e9e (valeur70) -\n    --cadastre_2023.pevtaxation.gp_vlbaia,              -- Groupement de commune - Part de VL impos\u00e9e (valeur de l\u2019ann\u00e9e) -\n    --cadastre_2023.pevtaxation.gp_bipevla              -- Groupement de commune - Base d\u2019imposition de la pev(valeur de l\u2019ann\u00e9e)\n    ROUND(cadastre_2023.pevtaxation.co_bipevla*(role.tf_header_article_a1_commune_taux.taux_bati_commune/100),2) AS tfpb_communale,\n    (cadastre_2023.pevtaxation.co_bipevla)::double precision/2 AS demi_base_imposition_pev_communale,\n    ROUND(cadastre_2023.pevtaxation.co_bipevla*(role.tf_header_article_a1_commune_taux.taux_bati_commune/100)/2,2) AS demi_tfpb_communale\n  FROM cadastre_2023.local00\n  INNER JOIN cadastre_2023.pev\n    ON cadastre_2023.pev.invar = cadastre_2023.local00.invar\n  INNER JOIN cadastre_2023.pevtaxation\n    ON cadastre_2023.pevtaxation.invar || cadastre_2023.pevtaxation.dnupev = cadastre_2023.pev.invar || cadastre_2023.pev.dnupev\n  INNER JOIN role.tf_header_article_a1_commune_taux\n    ON role.tf_header_article_a1_commune_taux.code_insee = cadastre_2023.local00.ccodep || cadastre_2023.local00.ccocom AND role.tf_header_article_a1_commune_taux.millesime = '2023'\n  INNER JOIN cadastre_2023.local10\n    ON cadastre_2023.local10.invar = cadastre_2023.local00.invar\n  LEFT JOIN cadastre_2023.pevprofessionnelle\n    ON cadastre_2023.pevprofessionnelle.invar =  cadastre_2023.local00.invar\n  ORDER BY RIGHT(cadastre_2023.local00.parcelle,12);\n</code></pre></p> <p>Explication</p> <p>Pour l'ensemble des parcelles du territoire de l'Agglom\u00e9ration, on r\u00e9cup\u00e8re :</p> <ul> <li>le code INSEE,</li> <li>le num\u00e9ro d'invariant du local,</li> <li>le code d'affectation et son libell\u00e9,</li> <li>le code de la nature du local et son libell\u00e9,</li> <li>la surface pond\u00e9r\u00e9e en m\u00b2 de la partie d'\u00e9valuation (PEV),</li> <li>la surface pond\u00e9r\u00e9e en m\u00b2 de la partie d'\u00e9valuation (PEV) pour les locaux \u00e0 titre professionnel,</li> <li>le taux communale sur les propri\u00e9t\u00e9s b\u00e2ties \u00e0 appliquer sur la Base d\u2019imposition,</li> <li>le taux communale sur les propri\u00e9t\u00e9s non b\u00e2ties \u00e0 appliquer sur la Base d\u2019imposition,</li> <li>la valeur locative de la PEV, en valeur de l'ann\u00e9e,</li> <li>le revenu cadastral (valeur locative/2),</li> <li>la base d\u2019imposition de la pev(valeur de l\u2019ann\u00e9e)</li> <li>la part de VL impos\u00e9e (valeur 70) du groupement de commune,</li> <li>la part de VL impos\u00e9e (valeur de l\u2019ann\u00e9e) du groupement de commune,</li> <li>la base d\u2019imposition de la pev (valeur de l\u2019ann\u00e9e) du groupement de commune,</li> <li>le calcul du reversement de la TFPB \u00e0 100%,</li> <li>le calcul du reversement de la TFPB \u00e0 50%.</li> </ul> <p>Cette requ\u00eate se veut assez exhaustive et le champ qui nous int\u00e9resse tout particuli\u00e8rement est demi_tfpb_communale qui est le calcul du reversement de la TFPB \u00e0 50% au titre du partage du produit de la taxe fonci\u00e8re sur les propri\u00e9t\u00e9s b\u00e2ties pour les sites \u00e9conomiques.</p> <p>Et la seconde requ\u00eate SQL : <pre><code>DROP TABLE IF EXISTS taxe.majic2023_revenu_cadastral_reversement_tfpb;\nCREATE TABLE taxe.majic2023_revenu_cadastral_reversement_tfpb AS\nSELECT  RIGHT(cadastre_2023.parcelle.parcelle,12) AS keypar,\n    CASE\n      WHEN SUM(taxe.majic2023_revenu_cadastral.demi_tfpb_communale) IS NULL THEN 0::numeric\n      ELSE SUM(taxe.majic2023_revenu_cadastral.demi_tfpb_communale)\n    END reversement\n  FROM taxe.majic2023_revenu_cadastral\n  RIGHT JOIN cadastre_2023.parcelle\n    ON RIGHT(cadastre_2023.parcelle.parcelle,12) = taxe.majic2023_revenu_cadastral.keypar\n  GROUP BY taxe.majic2023_revenu_cadastral.keypar, RIGHT(cadastre_2023.parcelle.parcelle,12)\n  ORDER BY taxe.majic2023_revenu_cadastral.keypar;\n\n --ALTER TABLE taxe.majic2023_revenu_cadastral_reversement_tfpb ADD PRIMARY KEY(gid);\n CREATE INDEX idx_majic2023_revenu_cadastral_reversement_tfpb_keypar ON taxe.majic2023_revenu_cadastral_reversement_tfpb USING btree (keypar COLLATE pg_catalog.\"default\");\n</code></pre></p> <p>Explication</p> <p>La premi\u00e8re requ\u00eate \u00e9tablit le montant du reversement de la TFPB pour chaque partie d'\u00e9valuation se trouvant sur une parcelle (pour une parcelle, on a une relation 0 \u00e0 N partie d'\u00e9valuation).</p> <p>Cette seconde requ\u00eate aggr\u00e8ge l'ensemble des montants du reversement de la TFPB pour avoir la somme global du reversement par parcelle.</p>","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]},{"location":"articles/2024/2024-04-19-finance-reversement-taxe-fonciere-zae/#apercu-dun-titre","title":"Aper\u00e7u d'un titre","text":"Exemple de titre","tags":["Finance","Taxe fonci\u00e8re","SQL","TFPB","MAJIC","Cadastre"]}]}